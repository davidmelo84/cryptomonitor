// front/crypto-monitor-frontend/src/components/pages/TradingBotsPage.jsx
// ‚úÖ VERS√ÉO CORRIGIDA - MODAL DE CRIA√á√ÉO FUNCIONANDO

import React, { useState, useEffect } from 'react';
import { 
  formatCurrency, 
  formatPercent, 
  formatPercentWithSign 
} from '../../utils/formatters';
import CreateBotModal from '../bots/CreateBotModal'; // ‚úÖ NOVO COMPONENTE
import '../../styles/trading-bots.css';

function TradingBotsPage({ token, onBack }) {
  const [bots, setBots] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');
  
  // ‚úÖ ESTADOS PARA MODAIS
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [selectedBot, setSelectedBot] = useState(null);

  useEffect(() => {
    fetchBots();
  }, []);

  const fetchBots = async () => {
    try {
      setLoading(true);
      const response = await fetch('http://localhost:8080/crypto-monitor/api/bots', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) throw new Error('Failed to fetch bots');

      const data = await response.json();
      
      if (data.success && data.bots) {
        setBots(data.bots);
      } else {
        setBots([]);
      }
    } catch (err) {
      console.error('Erro ao buscar bots:', err);
      setBots([]);
    } finally {
      setLoading(false);
    }
  };

  const filteredBots = bots.filter(bot => {
    if (filter === 'all') return true;
    if (filter === 'active') return bot.status === 'RUNNING';
    if (filter === 'inactive') return bot.status !== 'RUNNING';
    return true;
  });

  const toggleBotStatus = async (botId, currentStatus) => {
    try {
      const endpoint = currentStatus === 'RUNNING' ? 'stop' : 'start';
      
      const response = await fetch(
        `http://localhost:8080/crypto-monitor/api/bots/${botId}/${endpoint}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        }
      );

      if (!response.ok) throw new Error('Failed to update bot status');

      const data = await response.json();
      
      if (data.success) {
        alert(data.message);
        fetchBots();
      }
    } catch (err) {
      alert('Erro ao alterar status do bot: ' + err.message);
    }
  };

  const deleteBot = async (botId) => {
    if (!window.confirm('Deseja realmente excluir este bot?')) return;

    try {
      const response = await fetch(
        `http://localhost:8080/crypto-monitor/api/bots/${botId}`,
        {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      );

      if (!response.ok) throw new Error('Failed to delete bot');

      const data = await response.json();
      
      if (data.success) {
        alert(data.message);
        fetchBots();
      }
    } catch (err) {
      alert('Erro ao excluir bot: ' + err.message);
    }
  };

  const openBotDetails = (bot) => {
    setSelectedBot(bot);
    setShowDetailsModal(true);
  };

  // ‚úÖ NOVO: Handler para abrir modal de cria√ß√£o
  const openCreateModal = () => {
    setShowCreateModal(true);
  };

  // ‚úÖ NOVO: Handler quando bot √© criado com sucesso
  const handleBotCreated = () => {
    setShowCreateModal(false);
    fetchBots(); // Recarrega lista
  };

  if (loading) {
    return (
      <div className="trading-bots-page">
        <div className="loading-state">
          <div className="loading-spinner"></div>
          <p className="loading-text">Carregando bots de trading...</p>
        </div>
      </div>
    );
  }

  const activeBots = bots.filter(b => b.status === 'RUNNING').length;
  const totalProfit = bots.reduce((sum, b) => sum + parseFloat(b.totalProfitLoss || 0), 0);
  const totalTrades = bots.reduce((sum, b) => sum + (b.totalTrades || 0), 0);
  
  const avgWinRate = bots.length > 0
    ? bots.reduce((sum, b) => {
        const wins = b.winningTrades || 0;
        const total = b.totalTrades || 0;
        return sum + (total > 0 ? (wins / total) * 100 : 0);
      }, 0) / bots.length
    : 0;

  return (
    <div className="trading-bots-page">
      {/* Page Header */}
      <div className="page-header">
        <h1>ü§ñ Trading Bots</h1>
        <div className="header-actions">
          <button className="btn btn-secondary" onClick={onBack}>
            ‚Üê Voltar
          </button>
          {/* ‚úÖ CORRIGIDO: Adicionado onClick */}
          <button className="btn btn-primary" onClick={openCreateModal}>
            ‚ûï Novo Bot
          </button>
        </div>
      </div>

      {/* Summary Section */}
      <div className="summary-section">
        <div className="summary-grid">
          <div className="summary-card">
            <div className="summary-card-header">
              <div className="summary-card-icon">ü§ñ</div>
              <span className="summary-card-title">Total de Bots</span>
            </div>
            <div className="summary-card-value">{bots.length}</div>
            <div className="summary-card-subtitle">
              {activeBots} ativos
            </div>
          </div>

          <div className="summary-card">
            <div className="summary-card-header">
              <div className="summary-card-icon">üìä</div>
              <span className="summary-card-title">Lucro Total</span>
            </div>
            <div className="summary-card-value">
              {formatCurrency(totalProfit)}
            </div>
            <div className="summary-card-subtitle">
              <span className={`summary-card-change ${totalProfit >= 0 ? 'positive' : 'negative'}`}>
                {formatPercentWithSign(5.2)} este m√™s
              </span>
            </div>
          </div>

          <div className="summary-card">
            <div className="summary-card-header">
              <div className="summary-card-icon">üìà</div>
              <span className="summary-card-title">Taxa de Vit√≥ria</span>
            </div>
            <div className="summary-card-value">
              {formatPercent(avgWinRate)}
            </div>
            <div className="summary-card-subtitle">
              M√©dia de todos os bots
            </div>
          </div>

          <div className="summary-card">
            <div className="summary-card-header">
              <div className="summary-card-icon">üîÑ</div>
              <span className="summary-card-title">Opera√ß√µes</span>
            </div>
            <div className="summary-card-value">
              {totalTrades}
            </div>
            <div className="summary-card-subtitle">
              Total executadas
            </div>
          </div>
        </div>
      </div>

      {/* Bots Section */}
      <div className="bots-section">
        <div className="bots-header">
          <h2>Seus Bots</h2>
          <div className="bots-filters">
            <button 
              className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
              onClick={() => setFilter('all')}
            >
              Todos ({bots.length})
            </button>
            <button 
              className={`filter-btn ${filter === 'active' ? 'active' : ''}`}
              onClick={() => setFilter('active')}
            >
              Ativos ({activeBots})
            </button>
            <button 
              className={`filter-btn ${filter === 'inactive' ? 'active' : ''}`}
              onClick={() => setFilter('inactive')}
            >
              Inativos ({bots.length - activeBots})
            </button>
          </div>
        </div>

        {filteredBots.length === 0 ? (
          <div className="empty-state">
            <div className="empty-state-icon">ü§ñ</div>
            <h3 className="empty-state-title">Nenhum bot encontrado</h3>
            <p className="empty-state-description">
              {filter === 'all' 
                ? 'Crie seu primeiro bot de trading para come√ßar a automatizar suas opera√ß√µes.'
                : `Nenhum bot ${filter === 'active' ? 'ativo' : 'inativo'} no momento.`
              }
            </p>
            {/* ‚úÖ CORRIGIDO: Adicionado onClick */}
            {filter === 'all' && (
              <button className="btn btn-primary" onClick={openCreateModal}>
                ‚ûï Criar Primeiro Bot
              </button>
            )}
          </div>
        ) : (
          <div className="bots-grid">
            {filteredBots.map(bot => {
              const isRunning = bot.status === 'RUNNING';
              const profitLoss = parseFloat(bot.totalProfitLoss || 0);
              const winRate = bot.totalTrades > 0 
                ? (bot.winningTrades / bot.totalTrades) * 100 
                : 0;
              
              return (
                <div key={bot.id} className="bot-card">
                  <div className="bot-card-header">
                    <div className="bot-info">
                      <h3 className="bot-name">{bot.name}</h3>
                      <p className="bot-strategy">
                        {bot.strategy} ¬∑ {bot.coinSymbol}
                      </p>
                    </div>
                    <span className={`bot-status-badge ${isRunning ? 'active' : 'inactive'}`}>
                      {isRunning ? 'üü¢ Ativo' : 'üî¥ Parado'}
                    </span>
                  </div>

                  <div className="bot-card-body">
                    <div className="bot-description">
                      Bot de trading autom√°tico - {bot.isSimulation ? 'Modo Simula√ß√£o' : 'Modo Real'}
                    </div>

                    <div className="bot-metrics">
                      <div className="bot-metric">
                        <span className="bot-metric-label">Lucro Total</span>
                        <span className={`bot-metric-value ${profitLoss >= 0 ? 'positive' : 'negative'}`}>
                          {formatCurrency(profitLoss)}
                        </span>
                      </div>

                      <div className="bot-metric">
                        <span className="bot-metric-label">Opera√ß√µes</span>
                        <span className="bot-metric-value">
                          {bot.totalTrades || 0}
                        </span>
                      </div>

                      <div className="bot-metric">
                        <span className="bot-metric-label">Win Rate</span>
                        <span className="bot-metric-value">
                          {formatPercent(winRate)}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="bot-card-footer">
                    <button 
                      className="btn btn-secondary btn-sm"
                      onClick={() => openBotDetails(bot)}
                    >
                      üìä Detalhes
                    </button>

                    {isRunning ? (
                      <button 
                        className="btn btn-warning btn-sm"
                        onClick={() => toggleBotStatus(bot.id, bot.status)}
                      >
                        ‚è∏Ô∏è Pausar
                      </button>
                    ) : (
                      <button 
                        className="btn btn-success btn-sm"
                        onClick={() => toggleBotStatus(bot.id, bot.status)}
                      >
                        ‚ñ∂Ô∏è Ativar
                      </button>
                    )}

                    <button 
                      className="btn btn-danger btn-sm"
                      onClick={() => deleteBot(bot.id)}
                    >
                      üóëÔ∏è Excluir
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* ‚úÖ NOVO: Modal de Cria√ß√£o de Bot */}
      {showCreateModal && (
        <CreateBotModal
          token={token}
          onClose={() => setShowCreateModal(false)}
          onBotCreated={handleBotCreated}
        />
      )}

      {/* Modal de Detalhes (mantido) */}
      {showDetailsModal && selectedBot && (
        <div className="modal-overlay" onClick={() => setShowDetailsModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{selectedBot.name}</h2>
              <button 
                className="modal-close-btn"
                onClick={() => setShowDetailsModal(false)}
              >
                ‚úï
              </button>
            </div>

            <div className="modal-body">
              <div className="form-group">
                <label className="form-label">Estrat√©gia</label>
                <p>{selectedBot.strategy}</p>
              </div>

              <div className="form-group">
                <label className="form-label">Criptomoeda</label>
                <p>{selectedBot.coinSymbol}</p>
              </div>

              <div className="form-group">
                <label className="form-label">Status</label>
                <span className={`bot-status-badge ${selectedBot.status === 'RUNNING' ? 'active' : 'inactive'}`}>
                  {selectedBot.status}
                </span>
              </div>

              <div className="bot-metrics">
                <div className="bot-metric">
                  <span className="bot-metric-label">Lucro Total</span>
                  <span className={`bot-metric-value ${selectedBot.totalProfitLoss >= 0 ? 'positive' : 'negative'}`}>
                    {formatCurrency(selectedBot.totalProfitLoss || 0)}
                  </span>
                </div>

                <div className="bot-metric">
                  <span className="bot-metric-label">Total de Opera√ß√µes</span>
                  <span className="bot-metric-value">
                    {selectedBot.totalTrades || 0}
                  </span>
                </div>

                <div className="bot-metric">
                  <span className="bot-metric-label">Taxa de Vit√≥ria</span>
                  <span className="bot-metric-value">
                    {formatPercent(
                      selectedBot.totalTrades > 0 
                        ? (selectedBot.winningTrades / selectedBot.totalTrades) * 100 
                        : 0
                    )}
                  </span>
                </div>
              </div>
            </div>

            <div className="modal-footer">
              <button 
                className="btn btn-secondary"
                onClick={() => setShowDetailsModal(false)}
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default TradingBotsPage;