// back/src/main/java/com/crypto/service/VerificationService.java
package com.crypto.service;

import com.crypto.model.User;
import com.crypto.model.VerificationToken;
import com.crypto.repository.VerificationTokenRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.security.SecureRandom;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class VerificationService {

    private final VerificationTokenRepository tokenRepository;
    private final EmailService emailService;
    private static final SecureRandom RANDOM = new SecureRandom();

    /**
     * Gera c√≥digo de 6 d√≠gitos
     */
    private String generateCode() {
        int code = 100000 + RANDOM.nextInt(900000);
        return String.valueOf(code);
    }

    /**
     * Cria token de verifica√ß√£o e envia email
     */
    @Transactional
    public String createVerificationToken(User user) {
        // Deletar tokens antigos do usu√°rio
        tokenRepository.findByUser(user).ifPresent(tokenRepository::delete);

        // Gerar novo token e c√≥digo
        String token = UUID.randomUUID().toString();
        String code = generateCode();

        VerificationToken verificationToken = VerificationToken.builder()
                .token(token)
                .code(code)
                .user(user)
                .verified(false)
                .build();

        tokenRepository.save(verificationToken);

        // Enviar email com o c√≥digo
        sendVerificationEmail(user, code);

        log.info("üìß Token de verifica√ß√£o criado para: {}", user.getEmail());
        return token;
    }

    /**
     * Envia email com c√≥digo de verifica√ß√£o
     */
    private void sendVerificationEmail(User user, String code) {
        String subject = "üîê C√≥digo de Verifica√ß√£o - Crypto Monitor";

        String body = String.format("""
            Ol√° %s!
            
            Bem-vindo ao Crypto Monitor! üöÄ
            
            Para ativar sua conta, use o c√≥digo abaixo:
            
            ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            ‚ïë   C√ìDIGO: %s   ‚ïë
            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            
            Este c√≥digo √© v√°lido por 24 horas.
            
            Se voc√™ n√£o criou esta conta, ignore este email.
            
            Atenciosamente,
            Equipe Crypto Monitor
            """,
                user.getUsername(),
                code
        );

        emailService.sendEmail(user.getEmail(), subject, body);
    }

    /**
     * Verifica o c√≥digo informado
     */
    @Transactional
    public boolean verifyCode(String code) {
        return tokenRepository.findByCode(code)
                .map(token -> {
                    if (token.isExpired()) {
                        log.warn("‚ö†Ô∏è C√≥digo expirado: {}", code);
                        return false;
                    }

                    if (token.getVerified()) {
                        log.warn("‚ö†Ô∏è C√≥digo j√° utilizado: {}", code);
                        return false;
                    }

                    // Marcar como verificado
                    token.setVerified(true);
                    tokenRepository.save(token);

                    // Ativar usu√°rio
                    User user = token.getUser();
                    user.setEnabled(true);

                    log.info("‚úÖ Email verificado com sucesso: {}", user.getEmail());
                    return true;
                })
                .orElseGet(() -> {
                    log.warn("‚ùå C√≥digo inv√°lido: {}", code);
                    return false;
                });
    }

    /**
     * Reenvia c√≥digo de verifica√ß√£o
     */
    @Transactional
    public boolean resendCode(String email) {
        // Buscar usu√°rio n√£o verificado
        // Implementar l√≥gica no UserRepository
        return false; // Implementar
    }
}